<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
	
	angular.module('meetingApp', [])
		.controller('LoginController', function($scope, $rootScope, $http) {
			$scope.errors = [];
			$http.post("/me",{})
			.then(function(response){
				if (response.data.email)
					$rootScope.me = response.data;

				if ($rootScope.me) 
				{
					$rootScope.loginFlag = false;
					$rootScope.registerFlag = false;
				}
				else
				{
					$rootScope.loginFlag = true;
				}

			},function(response){

			});

			$scope.gotoRegister = function()
			{
				$rootScope.loginFlag = false;
				$rootScope.registerFlag = true;
			}
			$scope.gotoLogin = function()
			{
				$rootScope.loginFlag = true;
				$rootScope.registerFlag = false;
			}

			$scope.login = function(user)
			{
				$http.post("/login",user)
				.then(function(response){
					if (response.data.success)
					{
						$rootScope.me = response.data.me;
						$scope.errors = [];
						$rootScope.loginFlag = false;
						$rootScope.registerFlag = false;
					}
					else
					{
						$scope.errors.push(response.data.err);
						$scope.user = {};
						setTimeout(function(){
							$scope.$applyAsync(function(){	
								$scope.errors = [];
							})
						},2000);
					}
				},function(response){
					$rootScope.me = {};
				});
			}
			$scope.register = function(user)
			{
				$http.post("/register",user)
				.then(function(response){
					if (response.data.success)
					{
						$rootScope.me = response.data.me;
						$scope.errors = [];
						$rootScope.loginFlag = false;
						$rootScope.registerFlag = false;
					}
					else
					{
						$scope.errors.push(response.data.err);
						$scope.newUser = {};
						setTimeout(function(){
							$scope.$applyAsync(function(){	
								$scope.errors = [];
							})
						},2000);
					}
				},function(response){
					$rootScope.me = {};
				});
			}
		})
		.controller('MeetingController', function($scope, $rootScope, $http) {
			var t = this;
			$http.get('/meeting')
			.then(function(r){
				$scope.$applyAsync(function() 
				{
					console.log(r);
					t.m = r.data;
				});
			},console.log);

			this.debug = true;
			this.formData = {};
			// this.currentMeeting = {};

			this.lookupEmail = function()
			{
				$http.get("/user?email=" + t.newUser.email)
				.then(function(response){
					if(response.data.length == 1)
					{
						$scope.$applyAsync(function(){
							t.newUser = response.data[0];
						});
					}
				},console.log);
			}

			this.showParticipants = function(p)
			{
				$scope.$applyAsync(function() 
				{
					t.currentMeeting = p;
					t.invitees = p.invitees;
					t.attendees = p.attendees;
				});
			}

			this.addParticipant = function()
			{
				// http://localhost:1337/meeting/7/invitees/add/5
				$http.get("/user?email=" + t.newUser.email)
				.then(function(response){
					if(response.data.length == 1)
					{
						var updateRecord = {};
						updateRecord.name = t.newUser.name;
						updateRecord.surname = t.newUser.surname;
						updateRecord.deviceID = t.newUser.deviceID;

						console.log(t.newUser);
						$http.post('/user/update/' + response.data[0].id, updateRecord)
						.then(function(user)
						{
							//console.log(user);
							io.socket.get('/meeting/' + t.currentMeeting.id + '/invitees/add/' + user.data.id, function(r){
								$scope.$applyAsync(function() 
								{
									console.log(r);
									t.currentMeeting = r;
									t.invitees = r.invitees;
									t.attendees = r.attendees;
									t.newUser = {};
								});
							});
						},function(res){
							console.log(res);
						});
					}
					else
					{
						io.socket.post('/user/create', t.newUser, function(user)
						{
							console.log(user);
							io.socket.get('/meeting/' + t.currentMeeting.id + '/invitees/add/' + user.id, function(r){
								$scope.$applyAsync(function() 
								{
									console.log(r);
									t.currentMeeting = r;
									t.invitees = r.invitees;
									t.attendees = r.attendees;
									t.newUser = {};
								});
							});
						});
					}
				},console.log);
			}

			this.rmParticipant = function(p)
			{
				// http://localhost:1337/meeting/11/invitees/remove/1
				io.socket.get('/meeting/' + t.currentMeeting.id + '/invitees/remove/' + p, function(r){
					$scope.$applyAsync(function() 
					{
						console.log(r);
						t.currentMeeting = r;
						t.invitees = r.invitees;
						t.attendees = r.attendees;
					});
				});
			}

			this.submitForm = function()
			{
				io.socket.post('/meeting/create',t.formData,function(r)
				{
					$scope.$applyAsync(function() 
					{
						console.log(r);
						t.formData = {};
						io.socket.get('/meeting',function(r){
							$scope.$applyAsync(function() 
							{
								console.log(r);
								t.m = r;
							});
						});
					});	
				});
			}

			this.deleteMeeting = function(meeting)
			{
				console.log(meeting);
				io.socket.get('/meeting/destroy/' + meeting.id, function(r)
				{
					$scope.$applyAsync(function() 
					{
						console.log(r);	
						io.socket.get('/meeting',function(r){
							$scope.$applyAsync(function() 
							{
								console.log(r);
								t.m = r;
							});
						});
					});	
				});
			}
	});

</script>
<div class="container-fluid" style="padding: 20px" ng-app="meetingApp">

	<div class="row" ng-controller="LoginController as l" ng-show="loginFlag">
		<br/>
	    <br/>
	    <br/>
		<div class="col-md-offset-4 col-md-4 well">
		<h1 class="text-center">Login</h1>
		<p class="alert alert-danger" ng-repeat="error in errors" >{{error}}</p>

		  <div class="row">
		    <form role="form" class="form col-md-offset-2 col-md-8">
		      <h3>Email:</h3><input class="form-control" type="text" ng-model="user.email" placeholder="Email">
		      <h3>Password:</h3><input class="form-control" type="password" ng-model="user.password" placeholder="Password">
		      <br/>
		      <div class="pull-right">
		        <a ng-click="gotoRegister()" class="btn btn-primary" type="button">Register</a>
		        <button class="btn btn-success" type="button" ng-click="login(user)">Sign in</button>
		      </div>
		    </form>
		  </div>
		</div>
	</div>
	<div class="row" ng-controller="LoginController as l" ng-show="registerFlag">
	    <br/>
	    <br/>
	    <br/>
		<div class="col-md-offset-4 col-md-4 well">
		<h1 class="text-center">Register</h1>
		<p class="alert alert-danger" ng-repeat="error in errors" >{{error}}</p>

			<div class="row">
				<form role="form" class="col-md-offset-2 col-md-8">
					<h3>Name</h3><input class="form-control" type="text" ng-model="newUser.name" placeholder="John">
					<h3>Surname</h3><input class="form-control" type="text" ng-model="newUser.surname" placeholder="Dough">
					<h3>Email</h3><input class="form-control" type="text" ng-model="newUser.email" placeholder="Email">
					<h3>Password</h3><input class="form-control" type="password" ng-model="newUser.password" placeholder="Password">
					<br/>
				<div class="pull-right">
					<a ng-click="gotoLogin()" class="btn btn-primary" type="button">< Login</a>
					<button class="btn btn-success" type="button" ng-click="register(newUser)">Sign up</button>
				</div>
				</form>
			</div>
		</div>
	</div>
	<div class="row" ng-controller="MeetingController as meetings" ng-show="me.email">
	<div class="col-md-8 col-md-offset-2">
		<h1 style="text-align:center">Project EPIC Admin Dashboard</h1>
	</div>
	<div class="col-md-2">
		<a style="text-align:center" href="/logout" >Logout {{me.email}}</a>
	</div>
	</div>
	<div class="row" ng-controller="MeetingController as meetings" ng-show="me.email">
		<div class="col-md-7">
			<h3>Meetings</h3>
			<table class="table">
				<tr class="info">
					<td>Title</td>
					<td>Description</td>
					<td>Location</td>
					<td>Meeting Date Time</td>
					<td>Actions</td>
				</tr>
				<tr ng-repeat="meeting in meetings.m">
					<td>{{meeting.title}}</td>
					<td>{{meeting.description}}</td>
					<td>{{meeting.location}}</td>
					<td>{{meeting.dateTime}}</td>
					<td><a class="btn btn-primary" ng-click='meetings.showParticipants(meeting)'>Info</a> <a class="btn btn-danger" ng-click="meetings.deleteMeeting(meeting)">Delete</a></td>
				</tr>
				<tr>
					<td>
						<div class="form-group">
							<input class="form-control" placeholder="Title" type="text" ng-model="meetings.formData.title" value="My First Meeting" name="title" /><br/>
						</div>
					</td>
					<td>
						<div class="form-group">
							<input class="form-control" placeholder="Description" type="text" ng-model="meetings.formData.description" value="This is my first meeting" name="description" /><br/>
						</div>
					</td>
					<td>
						<div class="form-group">
							<input class="form-control" placeholder="Location" type="text" ng-model="meetings.formData.location" value="Meeting Room 1" name="location" /><br/>
						</div>
					</td>
					<td>
						<div class="form-group">
							<input class="form-control" type="datetime-local" ng-model="meetings.formData.dateTime" name="dateTime" /><br/>				    		
						</div>
					</td>
					<td>
							<a class="btn btn-success form-control" ng-click="meetings.submitForm()">Create Meeting</a> 
					</td>
				</tr>
			</table>
			<code ng-show="meetings.debug">
				<pre>{{meetings.formData}}</pre>
			</code>
		</div>
		<div ng-show="meetings.currentMeeting" class="col-md-5">
			<h3>{{meetings.currentMeeting.title}} Invitees</h3>
			<table class="table">
				<tr class="info">
					<td>Email</td>
					<td>Name</td>
					<td>Surname</td>
					<td>DeviceID</td>
					<td>Actions</td>
				</tr>
				<tr ng-repeat="p in meetings.invitees">
					<td><a href="mailto:{{p.email}}">{{p.email}}</a></td>
					<td>{{p.name}}</td>
					<td>{{p.surname}}</td>
					<td>{{p.deviceID}}</td>
					<td><a class="btn btn-warning" ng-click="meetings.rmParticipant(p.id)">Remove</a></td>
				</tr>
				<tr>
					<td><input class="form-control" placeholder="john@example.com" type="email" ng-blur="meetings.lookupEmail()" ng-model="meetings.newUser.email"/></td>
					<td><input class="form-control" placeholder="John" type="text" ng-model="meetings.newUser.name"/></td>
					<td><input class="form-control" placeholder="Dough" type="text" ng-model="meetings.newUser.surname"/></td>
					<td><input class="form-control" placeholder="123456-78910" type="text" ng-model="meetings.newUser.deviceID"/></td>
					<td><a ng-click="meetings.addParticipant()" class="btn btn-success">Invite</a></td>
				</tr>
			</table>
			<code ng-show="meetings.debug">
				<pre>{{meetings.newUser}}</pre>
			</code>

			<h3>Meeting Attendees</h3>
			<table class="table">
				<tr class="info">
					<td>Name</td>
					<td>Surname</td>
					<td>Email</td>
				</tr>
				<tr ng-repeat="p in meetings.attendees">
					<td>{{p.name}}</td>
					<td>{{p.surname}}</td>
					<td><a href="mailto:{{p.email}}">{{p.email}}</a></td>
				</tr>
			</table>
		</div>
	</div>
</div>
